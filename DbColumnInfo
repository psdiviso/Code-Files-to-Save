using System;
using System.Reflection;
using Diviso.Database.ValueConverters;

namespace Diviso.Database.Attributes;

[AttributeUsage(AttributeTargets.Property | AttributeTargets.Field, AllowMultiple = false, Inherited = true)]
public class DbColumnInfo : Attribute
{
    private Type valueConverter;

    public string Name { get; set; }

    public bool AutoGenerated { get; private set; }

    public Type ValueConverter
    {
        get
        {
            return valueConverter;
        }
        set
        {
            if (value != null)
            {
                if (value.GetConstructor(Type.EmptyTypes) == null)
                {
                    throw new MissingMethodException($"ValueConverters must have a parameterless constructor - {value.Name} doesn't");
                }

                if (!typeof(IValueConverter).IsAssignableFrom(value))
                {
                    throw new Exception($"ValueConverters must implement IValueConverter - {value.Name} doesn't");
                }
            }

            valueConverter = value;
        }
    }

    public IValueConverter ValueConverterInstance
    {
        get
        {
            if (!(ValueConverter == null))
            {
                return (IValueConverter)Activator.CreateInstance(ValueConverter);
            }

            return null;
        }
    }

    public DbColumnInfo()
    {
    }

    public DbColumnInfo(string Name)
    {
        this.Name = Name;
    }

    internal DbColumnInfo(string Name, bool AutoGenerated)
        : this(Name)
    {
        this.AutoGenerated = AutoGenerated;
    }

    public DbColumnInfo(string Name, Type ValueConverter)
        : this(Name)
    {
        this.ValueConverter = ValueConverter;
    }

    public static string GetColumnName(MemberInfo member)
    {
        DbColumnInfo customAttribute = member.GetCustomAttribute<DbColumnInfo>(inherit: true);
        if (customAttribute == null)
        {
            return member.Name;
        }

        return customAttribute.Name ?? member.Name;
    }
}
